# Создание статьи
@lab5.route('/create', methods=['GET', 'POST'])
def create_article():
    # Проверяем аутентификацию пользователя
    username = session.get('username')
    if not username:
        return redirect(url_for('lab5.login'))
    
    if request.method == 'POST':
        title = request.form.get('title')
        article_text = request.form.get('article_text')
        
        # Проверка на пустые поля
        if not title or not article_text:
            error = "Название и текст статьи не могут быть пустыми"
            return render_template('lab5/create_articles.html', error=error, username=username)
        
        conn = get_db_connection()
        if conn is None:
            error = "Ошибка подключения к базе данных"
            return render_template('lab5/create_articles.html', error=error, username=username)
        
        cursor = None
        try:
            cursor = conn.cursor(cursor_factory=RealDictCursor)
            
            # Находим ID пользователя
            cursor.execute("SELECT id FROM users WHERE login = %s;", (username,))
            user = cursor.fetchone()
            
            if not user:
                error = "Пользователь не найден"
                return render_template('lab5/create_articles.html', error=error, username=username)
            
            # Вставляем статью в базу данных
            cursor.execute(
                "INSERT INTO articles (title, article_text, user_id) VALUES (%s, %s, %s);",
                (title, article_text, user['id'])
            )
            
            return redirect(url_for('lab5.main'))
            
        except Error as e:
            if conn:
                conn.rollback()
            error = f"Ошибка при работе с БД: {e}"
            return render_template('lab5/create_articles.html', error=error, username=username)
        finally:
            close_db_connection(conn, cursor)
    
    return render_template('lab5/create_articles.html', username=username)