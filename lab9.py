from flask import Blueprint, render_template, request, session, jsonify

lab9 = Blueprint('lab9', __name__)

TOTAL_GIFTS = 10

# –ì–ª–æ–±–∞–ª—å–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: –∫–∞–∫–∏–µ –ø–æ–¥–∞—Ä–∫–∏ —É–∂–µ –ø—É—Å—Ç—ã–µ (–æ–±—â–∏–µ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
EMPTY_GIFTS = set()

# –ü–æ–¥–∞—Ä–∫–∏, –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º
AUTH_ONLY_GIFTS = {8, 9, 10}

WISHES = [
    "üéâ –ü—É—Å—Ç—å –≤ –Ω–æ–≤–æ–º –≥–æ–¥—É –±—É–¥–µ—Ç –±–æ–ª—å—à–µ —Ä–∞–¥–æ—Å—Ç–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤, —á–µ–º –ø–æ–≤–æ–¥–æ–≤ –¥–ª—è –≤–æ–ª–Ω–µ–Ω–∏–π!",
    "‚ú® –ñ–µ–ª–∞—é —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –≤ —Å–µ–±–µ, —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏—è –∏ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.",
    "üéÅ –ü—É—Å—Ç—å –≤—Å–µ —É—Å–∏–ª–∏—è –ø—Ä–∏–Ω–µ—Å—É—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –∞ –º–µ—á—Ç—ã —Å—Ç–∞–Ω—É—Ç —Ü–µ–ª—è–º–∏ –∏ —Å–±—É–¥—É—Ç—Å—è.",
    "‚ùÑÔ∏è –ü—É—Å—Ç—å –Ω–æ–≤—ã–π –≥–æ–¥ –±—É–¥–µ—Ç —Ç—ë–ø–ª—ã–º ‚Äî –¥–∞–∂–µ –≤ —Å–∞–º—ã–µ —Ö–æ–ª–æ–¥–Ω—ã–µ –¥–Ω–∏.",
    "üåü –ñ–µ–ª–∞—é —É—Å–ø–µ—Ö–æ–≤ –≤ —É—á—ë–±–µ, –ª—ë–≥–∫–∏—Ö –¥–µ–¥–ª–∞–π–Ω–æ–≤ –∏ –ø–æ–Ω—è—Ç–Ω—ã—Ö –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π üòâ",
    "üçÄ –ü—É—Å—Ç—å —É–¥–∞—á–∞ –±—É–¥–µ—Ç —Ä—è–¥–æ–º –≤–æ –≤—Å–µ—Ö –Ω–∞—á–∏–Ω–∞–Ω–∏—è—Ö.",
    "üí´ –ñ–µ–ª–∞—é –±–∞–ª–∞–Ω—Å–∞ –º–µ–∂–¥—É —Ä–∞–±–æ—Ç–æ–π, —É—á—ë–±–æ–π –∏ –æ—Ç–¥—ã—Ö–æ–º.",
    "üéä –ü—É—Å—Ç—å –Ω–æ–≤—ã–π –≥–æ–¥ –ø—Ä–∏–Ω–µ—Å—ë—Ç –ø—Ä–∏—è—Ç–Ω—ã–µ —Å—é—Ä–ø—Ä–∏–∑—ã –∏ —Ö–æ—Ä–æ—à–∏–µ –Ω–æ–≤–æ—Å—Ç–∏.",
    "‚ù§Ô∏è –ü—É—Å—Ç—å —Ä—è–¥–æ–º –±—É–¥—É—Ç –ª—é–¥–∏, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ –∏ —Å–ø–æ–∫–æ–π–Ω–æ.",
    "üéÑ –ñ–µ–ª–∞—é –≤–µ—Ä—ã –≤ —Å–µ–±—è –∏ –≤ —Ç–æ, —á—Ç–æ –≤—Å—ë –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–ª—É—á–∏—Ç—Å—è!"
]


def is_authed() -> bool:
    """
    –°—á–∏—Ç–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º, –µ—Å–ª–∏ –≤ session –µ—Å—Ç—å username –∏ –æ–Ω –Ω–µ anonymous.
    –ü–æ–¥—Å—Ç—Ä–æ–π –ø–æ–¥ —Å–≤–æ—é –õ–†-8, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –¥—Ä—É–≥–æ–π –∫–ª—é—á.
    """
    username = session.get('username', 'anonymous')
    return username != 'anonymous'


@lab9.route('/lab9/')
def index():
    # —Å—á—ë—Ç—á–∏–∫ –æ—Ç–∫—Ä—ã—Ç–∏–π –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤ —Å–µ—Å—Å–∏–∏)
    session.setdefault('opened_count', 0)
    return render_template('lab9/index.html', authed=is_authed())


@lab9.route('/lab9/state', methods=['GET'])
def state():
    """–û—Ç–¥–∞—ë–º —Ñ—Ä–æ–Ω—Ç—É —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (—Å—á–µ—Ç—á–∏–∫, –ø—É—Å—Ç—ã–µ –∫–æ—Ä–æ–±–∫–∏, –∫–∞–∫–∏–µ –ø–æ–¥–∞—Ä–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è authed)."""
    return jsonify({
        "ok": True,
        "authed": is_authed(),
        "opened_count": int(session.get('opened_count', 0)),
        "empty_gifts": sorted(list(EMPTY_GIFTS)),
        "auth_only_gifts": sorted(list(AUTH_ONLY_GIFTS)),
        "total_gifts": TOTAL_GIFTS
    })


@lab9.route('/lab9/open', methods=['POST'])
def open_gift():
    data = request.get_json(silent=True) or {}

    # –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –ø–∞—Ä—Å–∏–º id
    try:
        gift_id = int(data.get("id", 0))
    except (TypeError, ValueError):
        return jsonify({"ok": False, "error": "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π id –ø–æ–¥–∞—Ä–∫–∞"}), 400

    if gift_id < 1 or gift_id > TOTAL_GIFTS:
        return jsonify({"ok": False, "error": "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π id –ø–æ–¥–∞—Ä–∫–∞"}), 400

    # –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: —á–∞—Å—Ç—å –ø–æ–¥–∞—Ä–∫–æ–≤ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö
    if gift_id in AUTH_ONLY_GIFTS and not is_authed():
        return jsonify({
            "ok": False,
            "error": "–≠—Ç–æ—Ç –ø–æ–¥–∞—Ä–æ–∫ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º."
        }), 403

    # —É–∂–µ –ø—É—Å—Ç–æ–π (–æ–±—â–∏–π –¥–ª—è –≤—Å–µ—Ö)
    if gift_id in EMPTY_GIFTS:
        return jsonify({"ok": False, "error": "–≠—Ç–æ—Ç –ø–æ–¥–∞—Ä–æ–∫ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç –∫–µ–º-—Ç–æ —Ä–∞–Ω—å—à–µ (–∫–æ—Ä–æ–±–∫–∞ –ø—É—Å—Ç–∞—è)."}), 409

    # –ª–∏–º–∏—Ç 3 –ø–æ–¥–∞—Ä–∫–∞ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    opened_count = int(session.get("opened_count", 0))
    if opened_count >= 3:
        return jsonify({"ok": False, "error": "–í—ã —É–∂–µ –æ—Ç–∫—Ä—ã–ª–∏ 3 –ø–æ–¥–∞—Ä–∫–∞. –õ–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω."}), 429

    # –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–¥–∞—Ä–æ–∫
    EMPTY_GIFTS.add(gift_id)
    opened_count += 1
    session["opened_count"] = opened_count

    # –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ (–º–æ–∂–Ω–æ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–æ id)
    wish = WISHES[(gift_id - 1) % len(WISHES)]

    return jsonify({
        "ok": True,
        "gift_id": gift_id,
        "wish": wish,
        "opened_count": opened_count
    })


@lab9.route('/lab9/reset', methods=['POST'])
def reset_gifts():
    """
    –ö–Ω–æ–ø–∫–∞ ¬´–î–µ–¥ –ú–æ—Ä–æ–∑¬ª: —Å–Ω–æ–≤–∞ –Ω–∞–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ –∫–æ—Ä–æ–±–∫–∏ (—Å–¥–µ–ª–∞—Ç—å EMPTY_GIFTS –ø—É—Å—Ç—ã–º).
    –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º.
    """
    if not is_authed():
        return jsonify({"ok": False, "error": "–¢–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."}), 403

    EMPTY_GIFTS.clear()
    return jsonify({"ok": True})
